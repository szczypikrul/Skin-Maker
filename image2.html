<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Model with Sharp Combined Texture</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <style>
    canvas#canvas {
      border: 1px solid black;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; padding: 20px;">
    <!-- Podgląd 3D modelu -->
    <div>
      <h3>Model 3D</h3>
      <div id="p5Canvas"></div>
    </div>

    <!-- Sekcja wyboru i podglądu grafiki -->
    <div>
      <h3>Połącz Grafiki</h3>
      <label for="list1">Wybierz pierwszą grafikę:</label>
      <select id="list1">
        <option value="img/steve.png">Grafika 1</option>
        <option value="img/jaskiniowiec_skin.png">Grafika 2</option>
      </select>
      <br><br>
      <label for="list2">Wybierz drugą grafikę:</label>
      <select id="list2">
        <option value="img/steve.png">Grafika 1</option>
        <option value="img/jaskiniowiec_skin.png">Grafika 2</option>
      </select>
      <br><br>
      <button id="combine">Połącz grafiki</button>
      <br><br>
      <a id="download" style="display: none;" download="combined_texture.png">Pobierz obraz</a>
      <br><br>
      <canvas id="canvas" width="256" height="256"></canvas>
    </div>
  </div>

  <script>
    let mario;
    let generatedTexture;
    const canvasEl = document.getElementById('canvas');
    const ctx = canvasEl.getContext('2d');

    function preload() {
      mario = loadModel('model/model.obj', true);
    }

    function setup() {
      const canvas = createCanvas(400, 400, WEBGL);
      canvas.parent('p5Canvas');
      noStroke();
    }

    function draw() {
      background(220);
      orbitControl();
      rotateX(PI);

      if (generatedTexture) {
        texture(generatedTexture);
      }
      model(mario);
    }

    document.getElementById('combine').addEventListener('click', () => {
      const list1Value = document.getElementById('list1').value;
      const list2Value = document.getElementById('list2').value;

      const img1 = new Image();
      const img2 = new Image();

      img1.src = list1Value;
      img2.src = list2Value;

      img1.onload = () => {
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        ctx.drawImage(img1, 0, 0, canvasEl.width, canvasEl.height);

        img2.onload = () => {
          ctx.drawImage(img2, 0, 0, canvasEl.width, canvasEl.height);

          const canvasDataURL = canvasEl.toDataURL('image/png');

          loadImage(canvasDataURL, (img) => {
            generatedTexture = createGraphics(256, 256, WEBGL);

            // uzyskaj WebGL kontekst
            const gl = generatedTexture._renderer.GL;
            const tex = generatedTexture._renderer.getTexture(img);

            // ustaw NEAREST filtrację
            gl.bindTexture(gl.TEXTURE_2D, tex.glTex);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

            // narysuj teksturę, by p5 ją zarejestrował
            generatedTexture.texture(img);
            generatedTexture.plane(256);
          });

          const downloadLink = document.getElementById('download');
          downloadLink.href = canvasDataURL;
          downloadLink.style.display = 'inline';
        };
      };
    });
  </script>
</body>
</html>
